<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF_8">
        <link rel="stylesheet" href="CSS/all.css">
        <link rel="stylesheet" href="CSS/style.css">
        <title>LibraHub - Borrowing</title>
    </head>
    <body>
     <header>
        <div class="header-container">
            <div class="icon">
              <i class="fa-solid fa-book-open"></i>
                <h2>LibraHub</h2>
            </div>
            <div class="heah_link">
                <p class="search-p">Admin Panel</p>
                <a href="dashbord.html" class="serch-links a-login"><button class="dash-btn Dash-buuton">Dash Board</button></a>
                <a href="search.html" class="serch-links a-register"><button class="dash-btn search-buuton">Search</button></a>
                <a href="add.html" class="serch-links a-login"><button class="dash-btn search-buuton">Add Book</button></a>
                <a href="index.html" class="serch-links a-register"><button class="log-out-btn search-buuton">Log out <i class="fa-solid fa-right-from-bracket"></i></button></a>
            </div>
        </div>
     </header>

     <section class="brrow-form">
        <div class="brrow-card">
            <h2 class="brroe-tital">Borrow a Book</h2>
            
            <p class="p-selectuser">Select User</p>
            <select id="userDropdown" class="select_User">
                <option value="" hidden>--- Choose a User ---</option>
            </select>

            <p class="p-selectbook">Select Book</p>
            <select id="bookDropdown" class="select_Book">
                <option value="" hidden>--- Choose a Book ---</option>
            </select>

            <div class="borrow-date">
                <div class="right-date">
                    <p class="p-borrodate">Borrow Date</p>
                    <input type="date" id="borrowDateInput">
                </div>
                <div class="left-date">
                    <p class="p-borrodate">Due Date</p>
                    <input type="date" id="dueDateInput">
                </div>
            </div>

             <div class="borrow-btn">
                <button class="request-btn" id="submitBorrow">Request Borrowing</button>
                <button class="cancel-btn" onclick="window.location.reload()">Cancel</button>
             </div>
        </div>
     </section>

    <script>
        const userSelect = document.getElementById('userDropdown');
        const bookSelect = document.getElementById('bookDropdown');
        const submitBtn = document.getElementById('submitBorrow');
        const apiBase = "http://localhost:5042/api";

        // 1. Populate Members Dropdown using /api/Member/AllMember
        async function loadMembers() {
            try {
                const response = await fetch(`${apiBase}/Member/AllMember`);
                const members = await response.json();
                
                // Clear existing options
                userSelect.innerHTML = '<option value="" hidden>--- Choose a User ---</option>';
                
                members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id; // Using "id" from your API
                    option.textContent = member.name;
                    userSelect.appendChild(option);
                });
            } catch (err) {
                console.error("Failed to load members:", err);
            }
        }

        // 2. Populate Books Dropdown using /api/Book/AllBook
        async function loadBooks() {
            try {
                const response = await fetch(`${apiBase}/Book/showAllBooks`);
                const books = await response.json();
                
                bookSelect.innerHTML = '<option value="" hidden>--- Choose a Book ---</option>';
                
                books.forEach(book => {
                    const option = document.createElement('option');
                    // Explicitly using bookId based on your requirement
                    option.value = book.bookId || book.id; 
                    option.textContent = `${book.title} (Copies: ${book.availableCopies})`;
                    bookSelect.appendChild(option);
                });
            } catch (err) {
                console.error("Failed to load books:", err);
            }
        }

        // 3. POST to /api/Book/Borrow
        submitBtn.addEventListener('click', async () => {
            const borrowDate = document.getElementById('borrowDateInput').value;
            const dueDate = document.getElementById('dueDateInput').value;

            // Validate selection
            if (!userSelect.value || !bookSelect.value || !borrowDate || !dueDate) {
                alert("Please select a user, a book, and both dates.");
                return;
            }

            // Create JSON payload matching your Swagger schema
            const payload = {
                memberId: parseInt(userSelect.value),
                bookId: parseInt(bookSelect.value),
                title: bookSelect.options[bookSelect.selectedIndex].text.split(' (')[0],
                memeberName: userSelect.options[userSelect.selectedIndex].text,
                borrowDate: new Date(borrowDate).toISOString(),
                dueDate: new Date(dueDate).toISOString()
            };

            try {
                const response = await fetch(`${apiBase}/Book/Borrow`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("Book successfully borrowed!");
                    window.location.href = "dashbord.html"; // Redirect after success
                } else {
                    const errorText = await response.text();
                    alert("Error: " + errorText);
                }
            } catch (err) {
                console.error("Submission error:", err);
                alert("Could not connect to the server.");
            }
        });

        // Initialize page data
        loadMembers();
        loadBooks();
    </script>
    </body>
</html>